---
title: 数据库插入大量数据
date: 2024-02-01 13:50:21
tags:
  - 数据库
  - Java
categories:
  - 解决问题
---

在工作中遇到了一次性大批量向数据库插入数据的需求，调研了网络上的方法，发现都比较片面，在此记录整合测试并记录结果。

<!-- more -->

## 参数

| 参数       | 说明                 |
| ---------- | -------------------- |
| 线程数     | 插入任务工作线程数   |
| 批处理大小 | 每个线程插入多少数据 |
| 事务       | 是否开启自动提交     |
| 插入方式   | 插入使用的 Java 工具 |

## 预设场景

新建如下表：

```sql
CREATE TABLE `excel` (
  `id` int,
  `str` varchar(50),
  `num1` int,
  `num2` decimal(26,6),
  PRIMARY KEY (`id`)
);
```

测试数据量一百万；测试工具采用 JMH，JVM 参数 `-Xmx2048m`，预热一个迭代，测试一个迭代。

## 方案

### 单条自动提交插入

单线程，开启自动提交，一次插入一百万条，耗时 10 分钟超时。

### 单条开启事务插入

在单条自动提交插入的基础上，关闭自动提交，耗时 186.69 秒。数据库进程占满单核，JMH 进程占用单核约 50%。

gc 分析，内存未成瓶颈

### 分块插入

在单条开启事务插入的基础上，每一万条执行一次插入并提交，耗时 186.863 秒。
数据库进程占满单核，JMH 进程占用单核约 60%。

### 多线程插入

在批量插入的基础上，使用两个线程进行插入，耗时 97.194 秒。
数据库进程占用双核约 90%，JMH 进程占用双核约 80%

### 批量插入

在多线程插入的基础上，使用两个线程进行插入，耗时 11.977 秒。
数据库进程占用双核约 90%，JMH 进程占用双核约 80%

### LOAD DATA INFILE

在批量插入的基础上，使用两个线程进行插入，耗时 8.226 秒。
数据库进程占用双核约 90%，JMH 进程占用双核约 80%
